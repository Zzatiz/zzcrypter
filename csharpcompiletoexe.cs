using Microsoft.CSharp;
using System;
using System.CodeDom.Compiler;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Windows.Forms;

namespace laurentbd
{
    public class bd
    {
        // Read more to learn more...
        // docs.microsoft.com/en-us/dotnet/csharp/language-reference/compiler-options/listed-alphabetically
        public bd(string sourceCode, string savePath)
        {
            //include your references here
            string[] referencedAssemblies = new string[] { "System.dll", "System.Windows.Forms.dll", "Microsoft.VisualBasic.dll"};

            //.net framework dependency version
            Dictionary<string, string> providerOptions = new Dictionary<string, string>() { { "CompilerVersion", "v4.0" } };

            //target = Specifies the format of the output file by using one of four options: -target:appcontainerexe, -target:exe, -target:library, -target:module, -target:winexe, -target:winmdobj.
            //platform = Limits which platforms this code can run on: x86, Itanium, x64, anycpu, or anycpu32bitpreferred. The default is anycpu.
            //optimize = Enables/disables optimizations.
            string compilerOptions = "/target:appcontainerexe /platform:x86";

            using (CSharpCodeProvider cSharpCodeProvider = new CSharpCodeProvider(providerOptions))
            {
                CompilerParameters compilerParameters = new CompilerParameters(referencedAssemblies)
                {
                    GenerateExecutable = true,
                    GenerateInMemory = true,
                    OutputAssembly = savePath, // output path
                    CompilerOptions = compilerOptions,
                    TreatWarningsAsErrors = true,
                    IncludeDebugInformation = false,
                };

                CompilerResults compilerResults = cSharpCodeProvider.CompileAssemblyFromSource(compilerParameters, sourceCode); // source.cs
                if (compilerResults.Errors.Count > 0)
                {
                    foreach (CompilerError compilerError in compilerResults.Errors)
                    {
                        MessageBox.Show(string.Format("{0}\nLine: {1} - Column: {2}\nFile: {3}", compilerError.ErrorText,
                            compilerError.Line, compilerError.Column, compilerError.FileName));
                    }
                    return;
                }
                else
                {

                }
            }
        }
    }
}
